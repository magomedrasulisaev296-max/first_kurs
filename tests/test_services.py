# test_services.py
import json
import os
import sys

import pytest

from src.services import analyze_cashback_categories

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ src
sys.path.append(os.path.join(os.path.dirname(__file__), "..", "src"))


def test_analyze_cashback_basic():
    """–ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"""
    test_data = [
        {
            "–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": "2024-01-15",
            "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": "–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã",
            "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": -5000.0,
        },
        {
            "–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": "2024-01-20",
            "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": "–†–µ—Å—Ç–æ—Ä–∞–Ω—ã",
            "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": -3000.0,
        },
        {
            "–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": "2024-02-10",
            "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": "–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã",
            "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": -4000.0,
        },
    ]

    result = analyze_cashback_categories(test_data, 2024, 1)
    parsed = json.loads(result)

    assert "–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã" in parsed
    assert "–†–µ—Å—Ç–æ—Ä–∞–Ω—ã" in parsed
    assert parsed["–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã"] == 50.0  # 5000 * 0.01
    assert parsed["–†–µ—Å—Ç–æ—Ä–∞–Ω—ã"] == 30.0  # 3000 * 0.01
    assert len(parsed) == 2
    print("‚úÖ –ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç")


def test_empty_data():
    """–¢–µ—Å—Ç —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"""
    result = analyze_cashback_categories([], 2024, 1)
    parsed = json.loads(result)

    assert parsed == {}
    print("‚úÖ –ü—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ")


def test_wrong_month():
    """–¢–µ—Å—Ç –º–µ—Å—è—Ü–∞ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö"""
    test_data = [
        {
            "–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": "2024-01-15",
            "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": "–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã",
            "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": -5000.0,
        }
    ]

    result = analyze_cashback_categories(test_data, 2024, 2)  # –§–µ–≤—Ä–∞–ª—å
    parsed = json.loads(result)

    assert parsed == {}
    print("‚úÖ –ú–µ—Å—è—Ü –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö")


def test_missing_columns():
    """–¢–µ—Å—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∫–æ–ª–æ–Ω–æ–∫"""
    test_data = [{"–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": "2024-01-15", "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": -5000.0}]  # –ù–µ—Ç –ö–∞—Ç–µ–≥–æ—Ä–∏–∏

    with pytest.raises(ValueError, match="–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ö–∞—Ç–µ–≥–æ—Ä–∏—è"):
        analyze_cashback_categories(test_data, 2024, 1)
    print("‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–æ–Ω–æ–∫")


def test_positive_transactions():
    """–¢–µ—Å—Ç —Å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ (–∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)"""
    test_data = [
        {
            "–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": "2024-01-15",
            "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": "–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã",
            "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": 5000.0,
        },  # +
        {
            "–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": "2024-01-20",
            "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": "–†–µ—Å—Ç–æ—Ä–∞–Ω—ã",
            "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": -3000.0,
        },  # -
    ]

    result = analyze_cashback_categories(test_data, 2024, 1)
    parsed = json.loads(result)

    assert "–†–µ—Å—Ç–æ—Ä–∞–Ω—ã" in parsed
    assert "–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã" not in parsed  # –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
    assert parsed["–†–µ—Å—Ç–æ—Ä–∞–Ω—ã"] == 30.0
    print("‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è")


def test_null_category():
    """–¢–µ—Å—Ç —Å –ø—É—Å—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π"""
    test_data = [
        {"–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": "2024-01-15", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": None, "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": -5000.0},
        {
            "–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": "2024-01-20",
            "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": "–†–µ—Å—Ç–æ—Ä–∞–Ω—ã",
            "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": -3000.0,
        },
    ]

    result = analyze_cashback_categories(test_data, 2024, 1)
    parsed = json.loads(result)

    assert "–†–µ—Å—Ç–æ—Ä–∞–Ω—ã" in parsed
    assert len(parsed) == 1  # –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è
    print("‚úÖ –ü—É—Å—Ç—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è")


def test_multiple_categories():
    """–¢–µ—Å—Ç —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏"""
    test_data = [
        {"–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": "2024-01-01", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": "A", "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": -1000.0},
        {"–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": "2024-01-02", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": "B", "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": -2000.0},
        {"–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": "2024-01-03", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": "A", "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": -3000.0},
        {"–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": "2024-01-04", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": "C", "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": -4000.0},
    ]

    result = analyze_cashback_categories(test_data, 2024, 1)
    parsed = json.loads(result)

    assert parsed["A"] == 40.0  # (1000+3000)*0.01
    assert parsed["B"] == 20.0  # 2000*0.01
    assert parsed["C"] == 40.0  # 4000*0.01

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ —É–±—ã–≤–∞–Ω–∏—é
    categories = list(parsed.keys())
    assert categories[0] in ["A", "C"]  # –ù–∞–∏–±–æ–ª—å—à–∏–π –∫–µ—à–±—ç–∫
    print("‚úÖ –ù–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π")


def test_json_format():
    """–¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∞ JSON"""
    test_data = [
        {
            "–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": "2024-01-15",
            "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": "–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã",
            "–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏": -5000.0,
        }
    ]

    result = analyze_cashback_categories(test_data, 2024, 1)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON
    parsed = json.loads(result)
    assert isinstance(parsed, dict)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∏—Ä–∏–ª–ª–∏—Ü—É
    assert "–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã" in result

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç—Å—Ç—É–ø—ã (indent=2)
    lines = result.split("\n")
    assert len(lines) > 1  # –ù–µ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞
    print("‚úÖ –§–æ—Ä–º–∞—Ç JSON")


if __name__ == "__main__":
    print("üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ services...\n")

    test_analyze_cashback_basic()
    test_empty_data()
    test_wrong_month()
    test_missing_columns()
    test_positive_transactions()
    test_null_category()
    test_multiple_categories()
    test_json_format()

    print("\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!")
